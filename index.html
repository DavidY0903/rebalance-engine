<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Rebalance Engine v1.4</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h2 { color: #333; }
        .form-row { margin-bottom: 20px; }
        .drop-zone {
            width: 100%; padding: 20px;
            border: 2px dashed #aaa;
            text-align: center;
            cursor: pointer;
            color: #666;
        }
        .drop-zone.dragover { border-color: #333; color: #000; }
        #result { margin-top: 20px; }
        button { padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <h2>選擇你的輸入檔案</h2>
    <form id="rebalanceForm">
        <div class="form-row">
            <input type="file" name="file" id="fileInput" required hidden>
            <div id="dropZone" class="drop-zone">拖曳或點擊選擇檔案</div>
        </div>
        <div class="form-row">
            <button type="submit">Rebalance</button>
        </div>
    </form>
    <div id="result"></div>

    <script>
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const form = document.getElementById("rebalanceForm");
        const result = document.getElementById("result");

        dropZone.addEventListener("click", () => fileInput.click());
        dropZone.addEventListener("dragover", e => {
            e.preventDefault();
            dropZone.classList.add("dragover");
        });
        dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
        dropZone.addEventListener("drop", e => {
            e.preventDefault();
            dropZone.classList.remove("dragover");
            fileInput.files = e.dataTransfer.files;
            dropZone.textContent = fileInput.files[0].name;
        });
        fileInput.addEventListener("change", () => {
            if (fileInput.files.length > 0) {
                dropZone.textContent = fileInput.files[0].name;
            }
        });

        form.addEventListener("submit", async e => {
            e.preventDefault();
            if (!fileInput.files.length) return;

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            result.textContent = "處理中...";

            try {
                const res = await fetch("/api/rebalance", { method: "POST", body: formData });
                if (!res.ok) throw new Error("Rebalance failed");

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);

                // ✅ Always trust server-provided filename
                const disposition = res.headers.get("Content-Disposition");
                let filename = "rebalance_result.xlsx";
                if (disposition) {
                    const match = disposition.match(/filename\*?=(?:UTF-8''|")?([^\";]+)/);
                    if (match && match[1]) {
                        try {
                            filename = decodeURIComponent(match[1]);
                        } catch {
                            filename = match[1];
                        }
                    }
                }

                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                result.textContent = "✅ 已完成，檔案已下載: " + filename;
            } catch (err) {
                result.textContent = "❌ Error: " + err.message;
            }
        });
    </script>
</body>
</html>
